/*
 * angular-simple-chat 1.0.14
 * @description AngularJS chat directive
 * @link https://github.com/vogloblinsky/angular-simple-chat#readme
 * @license MIT
 */
!function(){"use strict";function e(e,t,n,s,o){return function(a,i,r){function l(){var e;if(p)e=p;else if(s.serverTime){var n=(new Date).getTime(),o=n-C+s.serverTime;e=t(o)}else e=t();return e}function c(){h&&(e.clearTimeout(h),h=null)}function m(t){var n=l().diff(t,"day"),s=w&&n>=w;if(s?i.text(t.format(y)):i.text(t.from(l(),v)),b&&!i.attr("title")&&i.attr("title",t.local().format(b)),!s){var o=Math.abs(l().diff(t,"minute")),a=3600;o<1?a=1:o<60?a=30:o<180&&(a=300),h=e.setTimeout(function(){m(t)},1e3*a)}}function u(e){U&&i.attr("datetime",e)}function d(){if(c(),g){var e=n.preprocessDate(g,$,f);m(e),u(e.toISOString())}}var g,p,h=null,f=o.format,v=s.withoutSuffix,b=s.titleFormat,w=s.fullDateThreshold,y=s.fullDateFormat,C=(new Date).getTime(),$=o.preprocess,T=r.amTimeAgo,U="TIME"===i[0].nodeName.toUpperCase();a.$watch(T,function(e){return"undefined"==typeof e||null===e||""===e?(c(),void(g&&(i.text(""),u(""),g=null))):(g=e,void d())}),angular.isDefined(r.amFrom)&&a.$watch(r.amFrom,function(e){p="undefined"==typeof e||null===e||""===e?null:t(e),d()}),angular.isDefined(r.amWithoutSuffix)&&a.$watch(r.amWithoutSuffix,function(e){"boolean"==typeof e?(v=e,d()):v=s.withoutSuffix}),r.$observe("amFormat",function(e){"undefined"!=typeof e&&(f=e,d())}),r.$observe("amPreprocess",function(e){$=e,d()}),r.$observe("amFullDateThreshold",function(e){w=e,d()}),r.$observe("amFullDateFormat",function(e){y=e,d()}),a.$on("$destroy",function(){c()}),a.$on("amMoment:localeChanged",function(){d()})}}function t(){function e(e,t,n,s){var o=s[0],a=s[1];a.options=o.options,a.localUser=o.localUser}var t={bindToController:!0,controller:n,controllerAs:"cb",link:e,restrict:"AE",require:["^simpleChat","chatBubble"],templateUrl:"directives/chat-bubble/chat-bubble.html",scope:{message:"="}};return t}function n(){}function s(){function e(e,t,n,s){var o=s[0],a=s[1];a.foreignobjectid=o.foreignobjectid,a.localUser=o.localUser,a.sendFunction=o.sendFunction,a.sendButtonText=o.sendButtonText,a.composerPlaceholderText=o.composerPlaceholderText,a.options=o.options,a.messages=o.messages,a.liveFlagFunction=o.liveFlagFunction,a.mentions=o.mentions,a.element=t.find("textarea")[0]}var t={bindToController:!0,controller:a,controllerAs:"mc",link:e,restrict:"AE",require:["^simpleChat","messageComposer"],templateUrl:"directives/message-composer/message-composer.html"};return t}function o(e){var t,n,s,o,a,i=0,r=0;return"number"==typeof e.selectionStart&&"number"==typeof e.selectionEnd?(i=e.selectionStart,r=e.selectionEnd):(n=document.selection.createRange(),n&&n.parentElement()==e&&(o=e.value.length,t=e.value.replace(/\r\n/g,"\n"),s=e.createTextRange(),s.moveToBookmark(n.getBookmark()),a=e.createTextRange(),a.collapse(!1),s.compareEndPoints("StartToEnd",a)>-1?i=r=o:(i=-s.moveStart("character",-o),i+=t.slice(0,i).split("\n").length-1,s.compareEndPoints("EndToEnd",a)>-1?r=o:(r=-s.moveEnd("character",-o),r+=t.slice(0,r).split("\n").length-1)))),{start:i,end:r}}function a(e){var t=this,n=!1,s=function(){if(angular.isDefined(t.rawmessage)){var s={id:"sc"+Date.now(),type:"message",text:t.rawmessage,userId:t.localUser.userId,avatar:t.localUser.avatar,userName:t.localUser.userName,date:Date.now()};t.options.liveMode&&angular.isDefined(t.liveFlagFunction)&&1===t.rawmessage.length&&t.liveFlagFunction({id:"sc"+Date.now(),type:"flag",userId:t.localUser.userId,label:"startSentence"}),n||t.sendFunction(s),t.options.liveMode&&!n?0===t.messages.length?t.messages.push(s):1===t.rawmessage.length?t.messages.push(s):t.messages[t.messages.length-1]=s:t.options.liveMode&&n?(n=!1,t.rawmessage="",t.liveFlagFunction({id:"sc"+Date.now(),type:"flag",userId:t.localUser.userId,label:"endSentence"})):t.messages.push(s),e.$emit("simple-chat-message-posted"),t.options.liveMode||(t.rawmessage="")}};e.$on("message-composer:appendText",function(e,n){n&&n.uuid&&n.text&&t.foreignobjectid==n.uuid&&(t.rawmessage+=n.text)}),this._send=function(){this.options.liveMode&&(n=!0),s()},this._onKeyDown=function(e){if(38===e.keyCode||40===e.keyCode)return e.preventDefault(),!1},this._onKeyUp=function(n){38==n.keyCode&&e.$emit("mention-up",this.foreignobjectid);var a,i=o(t.element);a=t.rawmessage&&t.rawmessage.length>0?t.rawmessage.substring(i.start-1,i.start):"","@"==n.key||"@"==a?(e.$emit("mention",this.foreignobjectid),this.inMention=!0):!a.match(/\w/)||this.inMention&&(32==n.keyCode||8==n.keyCode||46==n.keyCode)?(e.$emit("mention-stop",this.foreignobjectid),this.inMention=!1):this.inMention&&38==n.keyCode&&console.log("arrow up!"),this.inMention&&i.start==i.end,this.options.liveMode&&s()}}function i(){this.showUserAvatar=!0,this.showComposer=!0,this.liveMode=!1,this.showBubbleInfos=!0}function r(e){function t(t,n,s,o){var a=angular.element(n.children()[0])[0],i=function(){a.scrollTop=a.scrollHeight};t.$on("simple-chat-message-posted",function(){e(i,0)}),t.$watchCollection(function(){return t.sc.messages},function(t,n){e(i,0)}),angular.isDefined(o.messages)&&o.messages.length>0&&e(i,0),angular.isUndefined(o.messages)&&(o.messages=[])}var n={bindToController:!0,controller:"simpleChatController",controllerAs:"sc",link:t,restrict:"AE",templateUrl:"directives/simple-chat/simple-chat.html",scope:{messages:"=",localUser:"=",sendFunction:"=",showUserAvatar:"=",showComposer:"=",showBubbleInfos:"=",sendButtonText:"@",composerPlaceholderText:"@",liveMode:"=",liveFlagFunction:"=",mentions:"=",foreignobjectid:"="}};return n}function l(e){this.options=new i,angular.isDefined(this.showUserAvatar)&&this.options.setShowUserAvatar(this.showUserAvatar),angular.isDefined(this.showComposer)&&this.options.setShowComposer(this.showComposer),angular.isDefined(this.showBubbleInfos)&&this.options.setShowBubbleInfos(this.showBubbleInfos),angular.isDefined(this.liveMode)&&this.options.setLiveMode(this.liveMode)}function c(e){function t(t,n,s){n.bind("keydown",function(n){var o=n.which||n.keyCode;16!==o&&17!==o&&18!==o&&91!==o&&93!==o&&(13!==o&&e(function(){t.$apply(function(){t.$eval(s.onKeyUp)}),n.preventDefault()},0),13===o&&e(function(){t.$apply(function(){t.$eval(s.onEnterKey)}),n.preventDefault()},0))})}var n={link:t,restrict:"AE"};return n}e.$inject=["$window","moment","amMoment","amTimeAgoConfig","angularMomentConfig"],a.$inject=["$scope"],r.$inject=["$timeout"],l.$inject=["$scope"],c.$inject=["$timeout"],angular.module("angular-simple-chat",["angular-simple-chat.directives"]),angular.module("angular-simple-chat.directives",[]),angular.module("angular-simple-chat.directives").constant("moment",moment).constant("angularMomentConfig",{preprocess:null,timezone:"",format:null,statefulFilters:!0}).constant("amTimeAgoConfig",{withoutSuffix:!1,serverTime:null,titleFormat:null,fullDateThreshold:null,fullDateFormat:null}).service("amMoment",["moment","$rootScope","$log","angularMomentConfig",function(e,t,n,s){this.preprocessors={utc:e.utc,unix:e.unix},this.changeLocale=function(n,s){var o=e.locale(n,s);return angular.isDefined(n)&&t.$broadcast("amMoment:localeChanged"),o},this.changeTimezone=function(e){s.timezone=e,t.$broadcast("amMoment:timezoneChanged")},this.preprocessDate=function(t,o,a){return angular.isUndefined(o)&&(o=s.preprocess),this.preprocessors[o]?this.preprocessors[o](t,a):(o&&n.warn("angular-moment: Ignoring unsupported value for preprocess: "+o),!isNaN(parseFloat(t))&&isFinite(t)?e(parseInt(t,10)):e(t,a))},this.applyTimezone=function(e,t){return(t=t||s.timezone)?(t.match(/^Z|[+-]\d\d:?\d\d$/i)?e=e.utcOffset(t):e.tz?e=e.tz(t):n.warn("angular-moment: named timezone specified but moment.tz() is undefined. Did you forget to include moment-timezone.js?"),e):e}}]).directive("amTimeAgo",e),angular.module("angular-simple-chat.directives").directive("chatBubble",t),angular.module("angular-simple-chat.directives").directive("messageComposer",s),i.prototype.setShowUserAvatar=function(e){this.showUserAvatar=e},i.prototype.setShowComposer=function(e){this.showComposer=e},i.prototype.setLiveMode=function(e){this.liveMode=e},i.prototype.setShowBubbleInfos=function(e){this.showBubbleInfos=e},angular.module("angular-simple-chat.directives").directive("simpleChat",r),angular.module("angular-simple-chat.directives").controller("simpleChatController",l),angular.module("angular-simple-chat.directives").directive("voKeyUp",c),angular.module("angular-simple-chat.directives").run(["$templateCache",function(e){e.put("directives/chat-bubble/chat-bubble.html",'<div ng-if="cb.localUser.userId !== cb.message.userId">\n    <img class="profile-avatar left"\n        ng-src="{{cb.message.avatar}}"\n        ng-if="cb.options.showUserAvatar"/>\n    <div class="chat-bubble-container left"\n        ng-class="{\'reset-margin-left\': !cb.options.showUserAvatar}">\n        <div class="message-detail" ng-if="cb.options.showBubbleInfos">\n            <b>{{cb.message.userName}}, </b>\n            <span am-time-ago="cb.message.date"></span>\n        </div>\n        <div class="chat-bubble left">\n            <div class="message" ng-bind-html="cb.message.text">{{cb.message.text}}</div>\n        </div>\n    </div>\n</div>\n<div ng-if="cb.localUser.userId === cb.message.userId">\n    <img class="profile-avatar right"\n        ng-src="{{cb.localUser.avatar}}"\n        ng-if="cb.options.showUserAvatar"/>\n    <div class="chat-bubble-container right"\n        ng-class="{\'reset-margin-right\': !cb.options.showUserAvatar}">\n        <div class="message-detail" ng-if="cb.options.showBubbleInfos">\n            <b>{{cb.localUser.userName}}, </b>\n            <span am-time-ago="cb.message.date"></span>\n        </div>\n        <div class="chat-bubble right">\n            <div class="message" ng-bind-html="cb.message.text"></div>\n        </div>\n    </div>\n</div>\n'),e.put("directives/message-composer/message-composer.html",'<form name="composeForm">\n    <textarea  ng-attr-placeholder="{{mc.composerPlaceholderText || \'Write your message here.\'}}"\n            ng-model="mc.rawmessage"\n            name="message"\n            vo-key-up\n            ng-keyup="mc._onKeyUp($event)"\n            on-enter-key="mc._send()"\n            options="mc.options"\n            ng-required="true"\n            ng-keydown="mc._onKeyDown($event)"\n            ng-attr-id="message-composer_{{mc.foreignobjectid}}"></textarea>\n    <button ng-click="mc._send()" tabindex="-1"\n        ng-disabled="composeForm.$invalid">{{mc.sendButtonText || \'Send\'}}</button>\n</form>\n'),e.put("directives/simple-chat/simple-chat.html",'<div class="simple-chat-container"\n    ng-class="{\'full-height\': !sc.options.showComposer}">\n    <div ng-repeat="message in sc.messages track by message.id" class="message-wrapper">\n        <chat-bubble\n            message="message"\n            class="chat-bubble-main-container"\n        ></chat-bubble>\n    </div>\n</div>\n<message-composer\n    ng-if="sc.options.showComposer"\n></message-composer>\n')}])}();